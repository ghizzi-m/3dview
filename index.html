<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Diagnostic Tool</title>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; overflow: hidden; }
        #overlay { position: absolute; top: 0; left: 0; padding: 20px; z-index: 10; background: rgba(0,0,0,0.8); width: 100%; }
        h1 { margin: 0; color: #0ff; font-size: 20px; }
        .log-item { margin-top: 5px; font-size: 14px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .success { color: #0f0; }
        .error { color: #f55; font-weight: bold; }
        .warning { color: #fa0; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; transform: scaleX(-1); }
        canvas { position: absolute; top: 0; left: 0; z-index: 2; width: 100%; height: 100%; pointer-events: none; }
    </style>
</head>
<body>

    <div id="overlay">
        <h1>نظام فحص الكاميرا والجسيمات</h1>
        <div id="logs"></div>
    </div>

    <video id="webcam" playsinline autoplay muted></video>
    <canvas id="output_canvas"></canvas>

    <script type="module">
        import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm';

        // دالة لعرض الرسائل على الشاشة
        function log(msg, type = 'normal') {
            const el = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log-item ' + type;
            div.textContent = `> ${msg}`;
            el.appendChild(div);
            console.log(msg);
        }

        async function startApp() {
            // 1. فحص بروتوكول التشغيل
            if (window.location.protocol === 'file:') {
                log("خطأ قاتل: لا يمكن تشغيل الكاميرا من الملف مباشرة.", 'error');
                log("الحل: يجب استخدام Local Server أو رفع الملف على استضافة.", 'warning');
                alert("تحذير أمني: المتصفح يمنع الكاميرا في وضع الملفات المحلية (file://).");
                return;
            } else {
                log("بيئة التشغيل سليمة (Server/Localhost).", 'success');
            }

            // 2. فحص دعم المتصفح
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log("المتصفح لا يدعم الوصول للكاميرا أو السياق غير آمن.", 'error');
                return;
            }

            // 3. طلب الكاميرا
            log("جاري طلب صلاحية الكاميرا...");
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480 } 
                });
                const video = document.getElementById('webcam');
                video.srcObject = stream;
                
                await new Promise((resolve) => {
                    video.onloadeddata = () => {
                        log("تم تشغيل الكاميرا بنجاح!", 'success');
                        video.play();
                        resolve();
                    };
                });
            } catch (err) {
                log(`فشل تشغيل الكاميرا: ${err.name}`, 'error');
                if (err.name === 'NotAllowedError') {
                    log("السبب: المستخدم رفض الصلاحية. اضغط على أيقونة القفل بجانب الرابط.", 'warning');
                } else if (err.name === 'NotFoundError') {
                    log("السبب: لا توجد كاميرا متصلة بالجهاز.", 'warning');
                }
                return; // توقف هنا
            }

            // 4. تحميل الذكاء الاصطناعي
            log("جاري تحميل موديل تتبع اليد (قد يستغرق وقتاً)...");
            let handLandmarker;
            try {
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/wasm"
                );
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                log("تم تحميل الموديل بنجاح!", 'success');
            } catch (err) {
                log("فشل تحميل الموديل (تأكد من الاتصال بالإنترنت).", 'error');
                console.error(err);
                return;
            }

            // 5. بدء الرسم (حلقة بسيطة بدون Three.js للتأكد أولاً)
            const canvas = document.getElementById('output_canvas');
            const ctx = canvas.getContext('2d');
            const video = document.getElementById('webcam');

            function render() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                
                if (handLandmarker) {
                    const startTimeMs = performance.now();
                    const results = handLandmarker.detectForVideo(video, startTimeMs);

                    if (results.landmarks && results.landmarks.length > 0) {
                        // رسم دائرة خضراء مكان اليد
                        const hand = results.landmarks[0][9]; // منتصف اليد
                        const x = (1 - hand.x) * canvas.width;
                        const y = hand.y * canvas.height;

                        ctx.beginPath();
                        ctx.arc(x, y, 20, 0, 2 * Math.PI);
                        ctx.fillStyle = "#00ff00";
                        ctx.fill();
                        
                        // كتابة نص
                        ctx.font = "20px Arial";
                        ctx.fillStyle = "white";
                        ctx.fillText("تم اكتشاف اليد!", x + 30, y);
                    }
                }
                requestAnimationFrame(render);
            }
            log("بدء التتبع...", 'success');
            render();
        }

        startApp();
    </script>
</body>
</html>
