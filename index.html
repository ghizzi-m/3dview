<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Particles - No React</title>
    <style>
        body { margin: 0; background: black; overflow: hidden; font-family: monospace; color: #0ff; }
        canvas { display: block; width: 100vw; height: 100vh; }
        #info { position: absolute; top: 10px; left: 10px; z-index: 100; background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #0ff; pointer-events: none; }
        video { display: none; } /* نخفي الفيديو */
    </style>
</head>
<body>

    <div id="info">
        <h3>نظام تتبع اليد</h3>
        <div id="status">جاري تهيئة النظام...</div>
        <div id="log" style="color: yellow; font-size: 10px; margin-top:5px;"></div>
    </div>

    <video id="webcam" autoplay playsinline></video>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
        import { FilesetResolver, HandLandmarker } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/+esm';

        // متغيرات عامة
        let handLandmarker = undefined;
        let video = document.getElementById("webcam");
        let lastVideoTime = -1;
        let results = undefined;
        let particlesMesh;
        
        const statusDiv = document.getElementById("status");
        const logDiv = document.getElementById("log");

        function log(msg) {
            console.log(msg);
            logDiv.innerText = msg;
        }

        // 1. إعداد مشهد Three.js
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 5;

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. إنشاء الجزيئات
        const particleCount = 4000;
        const posArray = new Float32Array(particleCount * 3);
        const velocityArray = new Float32Array(particleCount * 3); // لتخزين السرعة

        for(let i = 0; i < particleCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 10; // انتشار عشوائي
            velocityArray[i] = 0;
        }

        const geometry = new THREE.BufferGeometry();
        geometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));

        const material = new THREE.PointsMaterial({
            size: 0.04,
            color: 0x00ffff,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending
        });

        particlesMesh = new THREE.Points(geometry, material);
        scene.add(particlesMesh);

        // 3. تشغيل الذكاء الاصطناعي (MediaPipe)
        async function createHandLandmarker() {
            try {
                log("جاري تحميل موديل الذكاء الاصطناعي...");
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.9/wasm"
                );
                
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task",
                        delegate: "GPU"
                    },
                    runningMode: "VIDEO",
                    numHands: 1
                });
                
                statusDiv.innerText = "تم تحميل الموديل! جاري فتح الكاميرا...";
                startWebcam();
            } catch (error) {
                statusDiv.innerText = "فشل تحميل الموديل.";
                log(error);
            }
        }

        // 4. تشغيل الكاميرا
        function startWebcam() {
            const constraints = { video: { width: 640, height: 480 } };
            navigator.mediaDevices.getUserMedia(constraints).then((stream) => {
                video.srcObject = stream;
                video.addEventListener("loadeddata", () => {
                    statusDiv.innerText = "النظام يعمل! لوح بيدك.";
                    log("الكاميرا تعمل.");
                    animate();
                });
            }).catch((err) => {
                statusDiv.innerText = "فشل الوصول للكاميرا.";
                log("تأكد من السماح للكاميرا: " + err);
            });
        }

        // 5. حلقة التحريك (Animation Loop)
        function animate() {
            requestAnimationFrame(animate);

            // كشف اليد
            if (handLandmarker && video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                results = handLandmarker.detectForVideo(video, performance.now());
            }

            // تحديد موقع الهدف (اليد أو المركز)
            let targetX = 0, targetY = 0, targetZ = 0;
            let isHandDetected = false;

            if (results && results.landmarks && results.landmarks.length > 0) {
                isHandDetected = true;
                // النقطة 9 هي منتصف اليد
                const hand = results.landmarks[0][9];
                
                // تحويل الإحداثيات لتناسب الشاشة
                // x في MediaPipe معكوس
                targetX = (0.5 - hand.x) * 8; 
                targetY = (0.5 - hand.y) * 5; 
                targetZ = 0;
            }

            // تحديث فيزياء الجزيئات
            const positions = particlesMesh.geometry.attributes.position.array;
            
            for (let i = 0; i < particleCount; i++) {
                const ix = i * 3;
                const iy = i * 3 + 1;
                const iz = i * 3 + 2;

                const px = positions[ix];
                const py = positions[iy];
                const pz = positions[iz];

                // المسافة نحو الهدف
                const dx = targetX - px;
                const dy = targetY - py;
                const dz = targetZ - pz;

                // قوة الجذب (تزيد إذا وجدت اليد)
                const force = isHandDetected ? 0.05 : 0.005;

                // تحديث السرعة
                velocityArray[ix] += dx * force;
                velocityArray[iy] += dy * force;
                velocityArray[iz] += dz * force;

                // الاحتكاك (لتهدئة الحركة)
                velocityArray[ix] *= 0.92;
                velocityArray[iy] *= 0.92;
                velocityArray[iz] *= 0.92;

                // تطبيق الحركة
                positions[ix] += velocityArray[ix];
                positions[iy] += velocityArray[iy];
                positions[iz] += velocityArray[iz];
            }

            particlesMesh.geometry.attributes.position.needsUpdate = true;
            
            // تدوير المشهد ببطء
            if (!isHandDetected) {
                particlesMesh.rotation.y += 0.002;
            }

            renderer.render(scene, camera);
        }

        // التعامل مع تغيير حجم النافذة
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // البدء
        createHandLandmarker();
    </script>
</body>
</html>